<style>
        /* ... (Styles pr√©c√©dents) ... */
        @media (min-width: 768px) { 
            .dashboard-grid { grid-template-columns: 1fr 1fr 1fr; } /* 3 colonnes sur PC */
            .full-width { grid-column: span 3; } 
        }
        .section-title { margin-bottom: 15px; color: #8e8e93; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; display: flex; justify-content: space-between; }
        .total-mini { font-weight: 700; color: #1d1d1f; }
        .btn-action.active { color: var(--blue); opacity: 1; font-weight: bold; }
    </style>

    <main>
        <div class="nav-bar">
            <button onclick="changeMonth(-1)">‚ù¨</button>
            <h2 id="month-label">...</h2>
            <button onclick="changeMonth(1)">‚ù≠</button>
        </div>

        <div class="dashboard-grid">
            <div class="card summary-card full-width">
                <div style="opacity: 0.8; font-size: 14px;">Reste √† vivre (apr√®s √©pargne)</div>
                <div id="restant" style="font-size: 38px; font-weight: 800; margin-top: 5px;">0 ‚Ç¨</div>
            </div>

            <div class="card">
                <div class="section-title">Revenus üíº <span id="sub-revenus" class="total-mini">0‚Ç¨</span></div>
                <div id="list-revenus"></div>
                <button class="add-btn" onclick="addItem('revenus')">+ Ajouter</button>
            </div>

            <div class="card">
                <div class="section-title">Charges üè† <span id="sub-charges" class="total-mini">0‚Ç¨</span></div>
                <div id="list-charges"></div>
                <button class="add-btn" onclick="addItem('charges')">+ Ajouter</button>
            </div>

            <div class="card">
                <div class="section-title">√âpargne üí∞ <span id="sub-epargne" class="total-mini">0‚Ç¨</span></div>
                <div id="list-epargne"></div>
                <button class="add-btn" onclick="addItem('epargne')">+ Ajouter</button>
            </div>
        </div>
    </main>

    <script>
        // ... Config et Init Firebase ...

        async function loadData() {
            const doc = await db.collection("users").doc(currentUser.uid).get();
            if (doc.exists) userData = doc.data();
            initMonthData(currentYear, currentMonthIdx); // Initialise le mois actuel
            render();
        }

        // LOGIQUE DE R√âCURRENCE AM√âLIOR√âE
        function initMonthData(year, monthIdx) {
            const key = `${year}_${months[monthIdx]}`;
            if (!userData[key]) {
                // On cherche le mois pr√©c√©dent chronologiquement
                let prevIdx = monthIdx - 1;
                let prevYear = year;
                if (prevIdx < 0) { prevIdx = 11; prevYear--; }
                
                const prevKey = `${prevYear}_${months[prevIdx]}`;
                const newData = { revenus: [], charges: [], epargne: [] };

                if (userData[prevKey]) {
                    // Importation automatique des √©l√©ments marqu√©s r√©currents
                    ['revenus', 'charges', 'epargne'].forEach(type => {
                        if (userData[prevKey][type]) {
                            newData[type] = userData[prevKey][type]
                                .filter(item => item.recurring === true)
                                .map(item => ({ ...item })); // Copie propre
                        }
                    });
                }
                userData[key] = newData;
            }
        }

        function render() {
            const key = `${currentYear}_${months[currentMonthIdx]}`;
            document.getElementById('month-label').innerText = `${months[currentMonthIdx]} ${currentYear}`;
            
            const types = ['revenus', 'charges', 'epargne'];
            let totals = { revenus: 0, charges: 0, epargne: 0 };

            types.forEach(type => {
                const list = userData[key][type] || [];
                totals[type] = list.reduce((s, i) => s + (Number(i.amount) || 0), 0);
                document.getElementById(`sub-${type}`).innerText = `${totals[type]}‚Ç¨`;
                
                const container = document.getElementById(`list-${type}`);
                container.innerHTML = list.map((item, idx) => `
                    <div class="item-row">
                        <div class="item-info">
                            <button class="btn-action ${item.recurring ? 'active' : ''}" 
                                    onclick="toggleRecurring('${type}', ${idx})">‚Üª</button>
                            <input class="editable" value="${item.category}" 
                                   onblur="updateItem('${type}', ${idx}, 'category', this.value)">
                        </div>
                        <input class="editable amount-input" type="number" value="${item.amount}" 
                               onblur="updateItem('${type}', ${idx}, 'amount', this.value)">
                        <button class="btn-action btn-delete" onclick="deleteItem('${type}', ${idx})">‚úï</button>
                    </div>
                `).join('');
            });

            document.getElementById('restant').innerText = `${totals.revenus - totals.charges - totals.epargne} ‚Ç¨`;
        }

        // ... (addItem, deleteItem, updateItem restent identiques, juste ajouter 'epargne' dans la logique) ...
        
        async function toggleRecurring(type, idx) {
            const key = `${currentYear}_${months[currentMonthIdx]}`;
            userData[key][type][idx].recurring = !userData[key][type][idx].recurring;
            await save();
        }

        function changeMonth(dir) {
            currentMonthIdx += dir;
            if (currentMonthIdx < 0) { currentMonthIdx = 11; currentYear--; }
            else if (currentMonthIdx > 11) { currentMonthIdx = 0; currentYear++; }
            initMonthData(currentYear, currentMonthIdx);
            render();
        }

        async function save() {
            render();
            await db.collection("users").doc(currentUser.uid).set(userData);
        }
    </script>
