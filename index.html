<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Budget | 2026</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <style>
        :root { --blue: #007aff; --bg: #f5f5f7; --red: #ff3b30; --green: #34c759; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, sans-serif; }
        body { background: var(--bg); color: #1d1d1f; padding-bottom: 40px; }
        header { background: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 0 rgba(0,0,0,0.05); }
        .avatar { width: 35px; height: 35px; border-radius: 50%; background: var(--blue); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        main { max-width: 1100px; margin: 20px auto; padding: 0 20px; }
        .dashboard-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 900px) { .dashboard-grid { grid-template-columns: 1fr 1fr 1fr; } .top-cards { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; grid-column: span 3; } }
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
        .summary-card { background: var(--blue); color: white; text-align: center; cursor: pointer; transition: transform 0.2s; }
        .summary-card:active { transform: scale(0.98); }
        .summary-card.savings { background: var(--green); cursor: default; }
        .nav-bar { display: flex; justify-content: space-between; align-items: center; margin: 20px 0; }
        .nav-bar button { border: none; background: white; width: 40px; height: 40px; border-radius: 12px; cursor: pointer; font-size: 18px; }
        .section-title { margin-bottom: 15px; color: #8e8e93; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; display: flex; justify-content: space-between; }
        .total-mini { font-weight: 700; color: #1d1d1f; }
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 0.5px solid #f2f2f7; gap: 10px; }
        .editable { border: none; background: transparent; font-size: 16px; width: 100%; outline: none; padding: 4px; border-radius: 6px; }
        .editable:focus { background: #f2f2f7; }
        .editable[readonly] { cursor: default; color: #1d1d1f; font-weight: 500; }
        .amount-input { font-weight: 600; text-align: right; width: 85px; color: var(--blue); }
        .btn-action { cursor: pointer; opacity: 0.2; transition: 0.2s; font-size: 18px; border: none; background: none; }
        .btn-action.active { opacity: 1; color: var(--blue); font-weight: bold; }
        .add-btn { width: 100%; padding: 12px; margin-top: 15px; border-radius: 12px; border: 1px dashed #d1d1d6; background: transparent; color: var(--blue); font-weight: 600; cursor: pointer; }

        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); }
        .modal-content { background: white; margin: 10% auto; padding: 25px; width: 90%; max-width: 500px; border-radius: 24px; position: relative; }
        .close-modal { position: absolute; right: 20px; top: 20px; font-size: 24px; cursor: pointer; opacity: 0.3; }
    </style>
</head>
<body>
    <header>
        <div style="display:flex; align-items:center; gap:10px;">
            <div id="user-avatar" class="avatar">?</div>
            <span id="user-email" style="font-size: 14px; font-weight: 500;">...</span>
        </div>
        <button onclick="firebase.auth().signOut()" style="border:none; background:none; color:var(--red); font-weight:600; cursor:pointer;">D√©connexion</button>
    </header>

    <main>
        <div class="nav-bar">
            <button onclick="changeMonth(-1)">‚ù¨</button>
            <h2 id="month-label" style="font-weight: 700;">...</h2>
            <button onclick="changeMonth(1)">‚ù≠</button>
        </div>

        <div class="dashboard-grid">
            <div class="top-cards">
                <div class="card summary-card" onclick="openSpendingModal()">
                    <div style="font-size: 14px; opacity: 0.8;">Reste √† vivre (disponible)</div>
                    <div id="restant" style="font-size: 38px; font-weight: 800; margin-top: 5px;">0 ‚Ç¨</div>
                    <div style="font-size: 11px; margin-top: 5px; opacity: 0.7;">Cliquez pour noter vos d√©penses</div>
                </div>
                <div class="card summary-card savings">
                    <div style="font-size: 14px; opacity: 0.8;">√âpargne cumul√©e √† ce jour</div>
                    <div id="total-savings-box" style="font-size: 38px; font-weight: 800; margin-top: 5px;">0 ‚Ç¨</div>
                </div>
            </div>

            <div class="card">
                <div class="section-title">Revenus üíº <span id="sub-revenus" class="total-mini">0‚Ç¨</span></div>
                <div id="list-revenus"></div>
                <button class="add-btn" onclick="addItem('revenus')">+ Ajouter</button>
            </div>

            <div class="card">
                <div class="section-title">Charges üè† <span id="sub-charges" class="total-mini">0‚Ç¨</span></div>
                <div id="list-charges"></div>
                <button class="add-btn" onclick="addItem('charges')">+ Ajouter</button>
            </div>

            <div class="card">
                <div class="section-title">√âpargne du mois üí∞ <span id="sub-epargne" class="total-mini">0‚Ç¨</span></div>
                <div id="list-epargne"></div>
            </div>
        </div>
    </main>

    <div id="spendingModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeSpendingModal()">‚úï</span>
            <h3 style="margin-bottom: 20px;">D√©penses quotidiennes</h3>
            <div id="list-depenses"></div>
            <button class="add-btn" onclick="addItem('depenses')">+ Noter un achat</button>
            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; text-align: right; font-weight: bold;">
                Total d√©pens√© : <span id="total-depenses-mini" style="color: var(--red);">0 ‚Ç¨</span>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCyt94XDHjrK87gKUwaST01c7CBu_lgCB4",
            authDomain: "budget-mensuel-52aa9.firebaseapp.com",
            projectId: "budget-mensuel-52aa9",
            storageBucket: "budget-mensuel-52aa9.appspot.com",
            messagingSenderId: "675021368593",
            appId: "1:675021368593:web:e64239a03c6cff30afb0b0"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const months = ["Janvier", "F√©vrier", "Mars", "Avril", "Mai", "Juin", "Juillet", "Ao√ªt", "Septembre", "Octobre", "Novembre", "D√©cembre"];
        
        const now = new Date();
        let currentYear = now.getFullYear();
        let currentMonthIdx = now.getMonth();
        
        let currentUser = null;
        let userData = {};

        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('user-email').innerText = user.email;
                document.getElementById('user-avatar').innerText = user.email[0].toUpperCase();
                loadData();
            } else { window.location.href = "login.html"; }
        });

        async function loadData() {
            const doc = await db.collection("users").doc(currentUser.uid).get();
            if (doc.exists) userData = doc.data();
            initMonthData(currentYear, currentMonthIdx);
            render();
        }

        function initMonthData(year, monthIdx) {
            const key = `${year}_${months[monthIdx]}`;
            if (!userData[key]) {
                let prevIdx = monthIdx - 1; let prevYear = year;
                if (prevIdx < 0) { prevIdx = 11; prevYear--; }
                const prevKey = `${prevYear}_${months[prevIdx]}`;
                
                const newData = { 
                    revenus: [], 
                    charges: [], 
                    depenses: [], 
                    epargne: [
                        { category: "√Ä √©pargner", amount: 0, recurring: false },
                        { category: "Retir√©", amount: 0, recurring: false }
                    ] 
                };
                if (userData[prevKey]) {
                    ['revenus', 'charges'].forEach(type => {
                        newData[type] = (userData[prevKey][type] || []).filter(i => i.recurring).map(i => ({ ...i }));
                    });
                }
                userData[key] = newData;
            }
            if (!userData[key].epargne || userData[key].epargne.length < 2) {
                userData[key].epargne = [{ category: "√Ä √©pargner", amount: 0 }, { category: "Retir√©", amount: 0 }];
            }
            if (!userData[key].depenses) userData[key].depenses = [];
        }

        function calculateSavingsUntilNow() {
            let total = 0;
            for (let y = 2025; y <= currentYear; y++) {
                for (let m = 0; m < 12; m++) {
                    if (y === currentYear && m > currentMonthIdx) break;
                    const key = `${y}_${months[m]}`;
                    if (userData[key] && userData[key].epargne) {
                        total += ((parseFloat(userData[key].epargne[0].amount) || 0) - (parseFloat(userData[key].epargne[1].amount) || 0));
                    }
                }
            }
            return total;
        }

        function render() {
            const key = `${currentYear}_${months[currentMonthIdx]}`;
            document.getElementById('month-label').innerText = `${months[currentMonthIdx]} ${currentYear}`;
            let totals = { revenus: 0, charges: 0, epargne: 0, depenses: 0 };

            ['revenus', 'charges', 'epargne', 'depenses'].forEach(type => {
                const list = userData[key][type] || [];
                if (type === 'epargne') {
                    totals[type] = (parseFloat(list[0]?.amount) || 0) - (parseFloat(list[1]?.amount) || 0);
                } else {
                    totals[type] = list.reduce((s, i) => s + (parseFloat(i.amount) || 0), 0);
                }
                
                if (document.getElementById(`sub-${type}`)) {
                    document.getElementById(`sub-${type}`).innerText = `${totals[type]} ‚Ç¨`;
                }

                const targetList = type === 'depenses' ? 'list-depenses' : `list-${type}`;
                document.getElementById(targetList).innerHTML = list.map((item, idx) => `
                    <div class="item-row">
                        <div style="display:flex; align-items:center; gap:8px; flex:1;">
                            ${(type !== 'epargne' && type !== 'depenses') ? 
                                `<button class="btn-action ${item.recurring ? 'active' : ''}" onclick="toggleRecurring('${type}', ${idx})">‚Üª</button>` 
                                : '<div style="width:25px"></div>'}
                            <input class="editable" value="${item.category}" 
                                onfocus="this.select()"
                                ${type === 'epargne' ? 'readonly' : `onblur="updateItem('${type}', ${idx}, 'category', this.value)"`}>
                        </div>
                        <input class="editable amount-input" type="number" value="${item.amount}" 
                            onfocus="this.select()"
                            style="color: ${(type === 'epargne' && idx === 1) || type === 'depenses' ? 'var(--red)' : 'var(--blue)'}"
                            onblur="updateItem('${type}', ${idx}, 'amount', this.value)">
                        ${type !== 'epargne' ? 
                            `<button class="btn-action" style="color:var(--red);opacity:0.2;" onclick="deleteItem('${type}', ${idx})">‚úï</button>` 
                            : '<div style="width:25px"></div>'}
                    </div>
                `).join('');
            });

            const netRestant = totals.revenus - totals.charges - totals.epargne - totals.depenses;
            document.getElementById('restant').innerText = `${netRestant} ‚Ç¨`;
            document.getElementById('total-savings-box').innerText = `${calculateSavingsUntilNow()} ‚Ç¨`;
            document.getElementById('total-depenses-mini').innerText = `${totals.depenses} ‚Ç¨`;
        }

        function openSpendingModal() { document.getElementById('spendingModal').style.display = 'block'; }
        function closeSpendingModal() { document.getElementById('spendingModal').style.display = 'none'; }
        window.onclick = (e) => { if(e.target == document.getElementById('spendingModal')) closeSpendingModal(); }

        function updateItem(type, idx, field, val) {
            const key = `${currentYear}_${months[currentMonthIdx]}`;
            userData[key][type][idx][field] = field === 'amount' ? parseFloat(val) || 0 : val;
            if (userData[key][type][idx].recurring && type !== 'epargne') propagateChange(type, userData[key][type][idx]);
            save();
        }

        function toggleRecurring(type, idx) {
            if (type === 'epargne' || type === 'depenses') return;
            const key = `${currentYear}_${months[currentMonthIdx]}`;
            const item = userData[key][type][idx];
            item.recurring = !item.recurring;
            item.recurring ? propagateChange(type, item) : removeFromFuture(type, item.category);
            save();
        }

        function propagateChange(type, item) {
            let tempMonth = currentMonthIdx; let tempYear = currentYear;
            for (let i = 0; i < 12; i++) {
                tempMonth++; if (tempMonth > 11) { tempMonth = 0; tempYear++; }
                const mKey = `${tempYear}_${months[tempMonth]}`;
                if (!userData[mKey]) initMonthData(tempYear, tempMonth);
                const exIdx = userData[mKey][type].findIndex(it => it.category === item.category);
                if (exIdx > -1) userData[mKey][type][exIdx] = { ...item, recurring: true };
                else userData[mKey][type].push({ ...item, recurring: true });
            }
        }

        function removeFromFuture(type, category) {
            let tempMonth = currentMonthIdx; let tempYear = currentYear;
            for (let i = 0; i < 12; i++) {
                tempMonth++; if (tempMonth > 11) { tempMonth = 0; tempYear++; }
                const mKey = `${tempYear}_${months[tempMonth]}`;
                if (userData[mKey]) userData[mKey][type] = userData[mKey][type].filter(it => it.category !== category);
            }
        }

        function addItem(type) {
            if (type === 'epargne') return;
            const key = `${currentYear}_${months[currentMonthIdx]}`;
            const newItem = { category: type === 'depenses' ? "D√©pense" : "Nouveau", amount: 0, recurring: false };
            userData[key][type].push(newItem);
            save();
        }

        function deleteItem(type, idx) {
            if (type === 'epargne') return;
            const key = `${currentYear}_${months[currentMonthIdx]}`;
            if (userData[key][type][idx].recurring) removeFromFuture(type, userData[key][type][idx].category);
            userData[key][type].splice(idx, 1);
            save();
        }

        function changeMonth(dir) {
            currentMonthIdx += dir;
            if (currentMonthIdx < 0) { currentMonthIdx = 11; currentYear--; }
            else if (currentMonthIdx > 11) { currentMonthIdx = 0; currentYear++; }
            initMonthData(currentYear, currentMonthIdx);
            render();
        }

        async function save() {
            render();
            await db.collection("users").doc(currentUser.uid).set(userData);
        }
    </script>
</body>
</html>
