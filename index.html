<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mon Budget | 2026</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <style>
        :root { 
            --blue: #007aff; 
            --bg: #f5f5f7; 
            --card-bg: #ffffff;
            --text: #1d1d1f;
            --text-secondary: #8e8e93;
            --border: #f2f2f7;
            --red: #ff3b30; 
            --green: #34c759; 
            --orange: #ff9500; 
        }

        /* Variables pour le Mode Nuit */
        body.dark-mode {
            --bg: #000000;
            --card-bg: #1c1c1e;
            --text: #ffffff;
            --text-secondary: #aeaeb2;
            --border: #2c2c2e;
        }

        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: -apple-system, sans-serif; 
        }

        body { 
            background: var(--bg); 
            color: var(--text); 
            padding-bottom: 40px; 
            overflow-x: hidden; 
            -webkit-tap-highlight-color: transparent; 
            transition: background 0.3s, color 0.3s;
        }

        header { 
            background: var(--card-bg); 
            padding: 15px 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: 0 1px 0 rgba(0,0,0,0.05); 
        }

        .avatar { 
            width: 32px; 
            height: 32px; 
            border-radius: 50%; 
            background: var(--blue); 
            color: white; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: bold; 
            font-size: 14px; 
            background-size: cover; 
            background-position: center; 
        }
        
        main { 
            max-width: 1400px; 
            margin: 10px auto; 
            padding: 0 15px; 
        }

        .dashboard-grid { 
            display: grid; 
            grid-template-columns: 1fr; 
            gap: 15px; 
        }

        .top-cards { 
            display: grid; 
            grid-template-columns: 1fr; 
            gap: 10px; 
        }

        @media (min-width: 1024px) { 
            .dashboard-grid { 
                grid-template-columns: repeat(4, 1fr); 
                gap: 20px; 
            } 
            .top-cards { 
                display: grid; 
                grid-template-columns: 1fr 1fr 1fr; 
                gap: 20px; 
                grid-column: span 4; 
            } 
            main { 
                margin: 20px auto; 
            }
        }

        .card { 
            background: var(--card-bg); 
            padding: 20px; 
            border-radius: 20px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.03); 
            height: fit-content; 
        }

        .summary-card { 
            color: white; 
            text-align: center; 
            cursor: pointer; 
            transition: transform 0.2s; 
            padding: 25px; 
            border-radius: 24px; 
        }

        .summary-card:active { 
            transform: scale(0.98); 
        }

        .summary-card.blue { background: var(--blue); }
        .summary-card.orange { background: var(--orange); }
        .summary-card.green { background: var(--green); cursor: default; }
        
        .nav-bar { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin: 15px 0; 
        }

        .nav-bar button { 
            border: none; 
            background: var(--card-bg); 
            color: var(--text);
            width: 40px; 
            height: 40px; 
            border-radius: 12px; 
            cursor: pointer; 
            font-size: 18px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
        }
        
        .section-title { 
            margin-bottom: 12px; 
            color: var(--text-secondary); 
            font-size: 11px; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }

        .total-mini { 
            font-weight: 700; 
            color: var(--text); 
            font-size: 13px; 
        }
        
        .item-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 12px 0; 
            border-bottom: 0.5px solid var(--border); 
            gap: 8px; 
        }

        .editable { 
            border: none; 
            background: transparent; 
            font-size: 15px; 
            width: 100%; 
            outline: none; 
            padding: 4px; 
            border-radius: 6px; 
            color: var(--text);
        }

        .editable:focus { 
            background: var(--border); 
        }

        .editable[readonly] { 
            cursor: default; 
            color: var(--text); 
            font-weight: 600; 
        }
        
        .amount-input { 
            font-weight: 700; 
            text-align: right; 
            width: 85px; 
            color: var(--blue); 
        }

        .btn-action { 
            cursor: pointer; 
            opacity: 0.2; 
            transition: 0.2s; 
            font-size: 17px; 
            border: none; 
            background: none; 
            padding: 4px; 
            color: var(--text);
        }

        .btn-action.active { 
            opacity: 1; 
            color: var(--blue); 
            font-weight: bold; 
        }

        .add-btn { 
            width: 100%; 
            padding: 12px; 
            margin-top: 10px; 
            border-radius: 12px; 
            border: 1px dashed var(--text-secondary); 
            background: transparent; 
            color: var(--blue); 
            font-weight: 600; 
            cursor: pointer; 
            font-size: 14px; 
        }

        .modal { 
            display: none; 
            position: fixed; 
            z-index: 100; 
            left: 0; top: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.5); 
            backdrop-filter: blur(8px); 
            cursor: pointer;
            align-items: center; justify-content: center;
        }

        .modal-content { 
            background: var(--card-bg); 
            color: var(--text);
            width: 92%; 
            max-width: 450px; 
            border-radius: 28px; 
            position: relative; 
            cursor: default;
            max-height: 80vh; 
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch;
            padding: 0 25px 25px 25px;
        }
        
        .modal-header {
            position: sticky;
            top: 0;
            background: var(--card-bg);
            padding: 25px 0 15px 0;
            z-index: 20;
            margin-bottom: 5px;
        }

        .close-modal { 
            position: absolute; right: 0; top: 25px; 
            font-size: 20px; cursor: pointer; opacity: 0.3; color: var(--text);
        }
        
        body.modal-open { overflow: hidden; }
        .keyboard-spacer { height: 0px; transition: height 0.3s; }

        .dark-toggle {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
        }
    </style>
</head>
<body onclick="">
    <header>
        <div style="display:flex; align-items:center; gap:10px;">
            <div id="user-avatar" class="avatar">?</div>
            <span id="user-email" style="font-size: 14px; font-weight: 600;">...</span>
        </div>
        <div style="display:flex; align-items:center; gap:15px;">
            <button onclick="toggleDarkMode()" class="dark-toggle" id="dark-btn">üåô</button>
            <button onclick="firebase.auth().signOut()" style="border:none; background:none; color:var(--red); font-weight:600; cursor:pointer; font-size: 14px;">Quitter</button>
        </div>
    </header>

    <main>
        <div class="nav-bar">
            <button onclick="changeMonth(-1)">‚ù¨</button>
            <h1 id="month-label" style="font-weight: 800; font-size: 22px;">...</h1>
            <button onclick="changeMonth(1)">‚ù≠</button>
        </div>

        <div class="dashboard-grid">
            <div class="top-cards">
                <div class="card summary-card blue" onclick="openModal('spendingModal')">
                    <div style="font-size: 13px; opacity: 0.9;">Disponible</div>
                    <div id="restant" style="font-size: 32px; font-weight: 900; margin-top: 4px;">0 ‚Ç¨</div>
                </div>
                <div class="card summary-card orange" onclick="openModal('coursesModal')">
                    <div style="font-size: 13px; opacity: 0.9;">Reste Courses</div>
                    <div id="courses-restant" style="font-size: 32px; font-weight: 900; margin-top: 4px;">0 ‚Ç¨</div>
                </div>
                <div class="card summary-card green">
                    <div style="font-size: 13px; opacity: 0.9;">√âpargne Totale</div>
                    <div id="total-savings-box" style="font-size: 32px; font-weight: 900; margin-top: 4px;">0 ‚Ç¨</div>
                </div>
            </div>

            <div class="card">
                <div class="section-title">Revenus üíº <span id="sub-revenus" class="total-mini">0‚Ç¨</span></div>
                <div id="list-revenus"></div>
                <button class="add-btn" onclick="addItem('revenus')">+ Ajouter</button>
            </div>

            <div class="card">
                <div class="section-title">Charges üè† <span id="sub-charges" class="total-mini">0‚Ç¨</span></div>
                <div id="list-charges"></div>
                <button class="add-btn" onclick="addItem('charges')">+ Ajouter</button>
            </div>

            <div class="card">
                <div class="section-title">Budget Courses üõí <span id="sub-budget_courses" class="total-mini">0‚Ç¨</span></div>
                <div id="list-budget_courses"></div>
            </div>

            <div class="card">
                <div class="section-title">√âpargne du mois üí∞ <span id="sub-epargne" class="total-mini">0‚Ç¨</span></div>
                <div id="list-epargne"></div>
            </div>
        </div>
    </main>

    <div id="spendingModal" class="modal" onclick="closeModal('spendingModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span class="close-modal" onclick="closeModal('spendingModal')">‚úï</span>
                <h3 style="font-size: 20px;">D√©penses quotidiennes</h3>
            </div>
            <div id="list-depenses"></div>
            <button class="add-btn" onclick="addItem('depenses')">+ Noter un achat</button>
            <div class="keyboard-spacer"></div>
        </div>
    </div>

    <div id="coursesModal" class="modal" onclick="closeModal('coursesModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span class="close-modal" onclick="closeModal('coursesModal')">‚úï</span>
                <h3 style="font-size: 20px;">D√©tails des courses</h3>
            </div>
            <div id="list-tickets_courses"></div>
            <button class="add-btn" onclick="addItem('tickets_courses')">+ Ajouter un ticket</button>
            <div class="keyboard-spacer"></div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCyt94XDHjrK87gKUwaST01c7CBu_lgCB4",
            authDomain: "budget-mensuel-52aa9.firebaseapp.com",
            projectId: "budget-mensuel-52aa9",
            storageBucket: "budget-mensuel-52aa9.appspot.com",
            messagingSenderId: "675021368593",
            appId: "1:675021368593:web:e64239a03c6cff30afb0b0"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const months = ["Janvier", "F√©vrier", "Mars", "Avril", "Mai", "Juin", "Juillet", "Ao√ªt", "Septembre", "Octobre", "Novembre", "D√©cembre"];
        
        const today = new Date();
        let currentYear = today.getFullYear();
        let currentMonthIdx = today.getMonth();
        let currentUser = null;
        let userData = {};

        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('user-email').innerText = user.email;
                const avatar = document.getElementById('user-avatar');
                if (user.photoURL) {
                    avatar.style.backgroundImage = `url(${user.photoURL})`;
                    avatar.innerText = "";
                } else {
                    avatar.innerText = user.email[0].toUpperCase();
                }
                loadData();
            } else { 
                window.location.href = "login.html"; 
            }
        });

        // --- GESTION DU MODE NUIT ---
        function toggleDarkMode() {
            const isDark = document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', isDark);
            updateDarkBtn(isDark);
        }

        function updateDarkBtn(isDark) {
            document.getElementById('dark-btn').innerText = isDark ? '‚òÄÔ∏è' : 'üåô';
        }

        if (localStorage.getItem('darkMode') === 'true' || 
           (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches && localStorage.getItem('darkMode') === null)) {
            document.body.classList.add('dark-mode');
            updateDarkBtn(true);
        }

        // --- FONCTIONS DE DONN√âES ---
        async function loadData() {
            const doc = await db.collection("users").doc(currentUser.uid).get();
            if (doc.exists) {
                userData = doc.data();
            } else {
                userData = {};
            }
            initMonthData(currentYear, currentMonthIdx);
            render();
            save();
        }

        function initMonthData(year, monthIdx) {
            const key = `${year}_${months[monthIdx]}`;
            if (!userData[key]) {
                let prevIdx = monthIdx - 1; 
                let prevYear = year;
                if (prevIdx < 0) { prevIdx = 11; prevYear--; }
                const prevKey = `${prevYear}_${months[prevIdx]}`;
                
                const newData = { 
                    revenus: [], 
                    charges: [], 
                    depenses: [], 
                    tickets_courses: [], 
                    budget_courses: [{ category: "Budget", amount: 0, recurring: true }], 
                    epargne: [{ category: "√Ä √©pargner", amount: 0 }, { category: "Retir√©", amount: 0 }] 
                };

                if (userData[prevKey]) {
                    ['revenus', 'charges', 'budget_courses'].forEach(type => {
                        newData[type] = (userData[prevKey][type] || []).filter(i => i.recurring).map(i => ({ ...i }));
                    });
                }
                userData[key] = newData;
            }
        }

        function render() {
            const key = `${currentYear}_${months[currentMonthIdx]}`;
            document.getElementById('month-label').innerText = `${months[currentMonthIdx]} ${currentYear}`;
            
            if (!userData[key]) return;

            let totals = { revenus: 0, charges: 0, epargne: 0, depenses: 0, budget_courses: 0, tickets_courses: 0 };

            ['revenus', 'charges', 'epargne', 'depenses', 'budget_courses', 'tickets_courses'].forEach(type => {
                const list = userData[key][type] || [];
                
                if (type === 'epargne') {
                    totals[type] = (parseFloat(list[0]?.amount) || 0) - (parseFloat(list[1]?.amount) || 0);
                } else {
                    totals[type] = list.reduce((s, i) => s + (parseFloat(i.amount) || 0), 0);
                }
                
                if (document.getElementById(`sub-${type}`)) {
                    document.getElementById(`sub-${type}`).innerText = `${Math.round(totals[type])} ‚Ç¨`;
                }

                let targetId = type === 'depenses' ? 'list-depenses' : type === 'tickets_courses' ? 'list-tickets_courses' : `list-${type}`;
                const element = document.getElementById(targetId);
                
                if (element) {
                    element.innerHTML = list.map((item, idx) => `
                        <div class="item-row">
                            <div style="display:flex; align-items:center; gap:8px; flex:1;">
                                ${(type !== 'epargne' && type !== 'depenses' && type !== 'tickets_courses' && type !== 'budget_courses') ? 
                                `<button class="btn-action ${item.recurring ? 'active' : ''}" onclick="toggleRecurring('${type}', ${idx})">‚Üª</button>` : 
                                '<div style="width:25px"></div>'}
                                <input class="editable" value="${item.category}" 
                                    onfocus="handleFocus(this)" 
                                    onchange="updateItem('${type}', ${idx}, 'category', this.value)"
                                    onblur="handleBlur(this)">
                            </div>
                            <input class="editable amount-input" type="number" inputmode="decimal" value="${item.amount}" 
                                onfocus="handleFocus(this)" 
                                style="color: ${(type === 'epargne' && idx === 1) || type === 'depenses' || type === 'tickets_courses' ? 'var(--red)' : 'var(--blue)'}" 
                                onchange="updateItem('${type}', ${idx}, 'amount', this.value)"
                                onblur="handleBlur(this)">
                            ${type !== 'epargne' && (type !== 'budget_courses' || idx !== 0) ? 
                            `<button class="btn-action" style="color:var(--red);opacity:0.2;" onclick="deleteItem('${type}', ${idx})">‚úï</button>` : 
                            '<div style="width:25px"></div>'}
                        </div>`).join('');
                }
            });

            const netRestant = totals.revenus - totals.charges - totals.epargne - totals.depenses - totals.budget_courses;
            document.getElementById('restant').innerText = `${Math.round(netRestant)} ‚Ç¨`;
            document.getElementById('courses-restant').innerText = `${Math.round(totals.budget_courses - totals.tickets_courses)} ‚Ç¨`;
            
            let cumule = 0;
            Object.keys(userData).forEach(k => {
                if (userData[k].epargne) {
                    cumule += ((parseFloat(userData[k].epargne[0].amount) || 0) - (parseFloat(userData[k].epargne[1].amount) || 0));
                }
            });
            document.getElementById('total-savings-box').innerText = `${Math.round(cumule)} ‚Ç¨`;
        }

        function handleFocus(el) {
            el.select();
            const modalContent = el.closest('.modal-content');
            if (modalContent) {
                const spacer = modalContent.querySelector('.keyboard-spacer');
                if (spacer) spacer.style.height = "300px";
                setTimeout(() => {
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 400);
            }
        }

        function handleBlur(el) {
            const modalContent = el.closest('.modal-content');
            if (modalContent) {
                const spacer = modalContent.querySelector('.keyboard-spacer');
                if (spacer) spacer.style.height = "0px";
            }
        }

        function openModal(id) { 
            const m = document.getElementById(id);
            m.style.display = 'flex';
            document.body.classList.add('modal-open');
        }

        function closeModal(id) { 
            const m = document.getElementById(id);
            m.style.display = 'none'; 
            document.body.classList.remove('modal-open');
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                closeModal('spendingModal');
                closeModal('coursesModal');
            }
        };

        function updateItem(type, idx, field, val) {
            const key = `${currentYear}_${months[currentMonthIdx]}`;
            if(!userData[key] || !userData[key][type][idx]) return;
            userData[key][type][idx][field] = field === 'amount' ? parseFloat(val) || 0 : val;
            if (type === 'budget_courses' || userData[key][type][idx].recurring) {
                propagateChange(type, userData[key][type][idx]);
            }
            save();
        }

        function toggleRecurring(type, idx) {
            const key = `${currentYear}_${months[currentMonthIdx]}`;
            const item = userData[key][type][idx];
            item.recurring = !item.recurring;
            item.recurring ? propagateChange(type, item) : removeFromFuture(type, item.category);
            save();
        }

        function propagateChange(type, item) {
            let m = currentMonthIdx; let y = currentYear;
            for (let i = 0; i < 12; i++) {
                m++; if (m > 11) { m = 0; y++; }
                const k = `${y}_${months[m]}`;
                if (!userData[k]) initMonthData(y, m);
                if (type === 'budget_courses') {
                    if (userData[k][type] && userData[k][type][0]) userData[k][type][0].amount = item.amount;
                } else {
                    const ex = userData[k][type].findIndex(it => it.category === item.category);
                    if (ex > -1) userData[k][type][ex] = { ...item };
                    else userData[k][type].push({ ...item });
                }
            }
        }

        function removeFromFuture(type, category) {
            let m = currentMonthIdx; let y = currentYear;
            for (let i = 0; i < 12; i++) {
                m++; if (m > 11) { m = 0; y++; }
                const k = `${y}_${months[m]}`;
                if (userData[k] && userData[k][type]) {
                    userData[k][type] = userData[k][type].filter(it => it.category !== category);
                }
            }
        }

        function addItem(type) {
            const key = `${currentYear}_${months[currentMonthIdx]}`;
            if (!userData[key][type]) userData[key][type] = [];
            userData[key][type].push({ 
                category: (type === 'tickets_courses' ? "Courses" : "Nouveau"), 
                amount: 0, 
                recurring: false 
            });
            save();
            setTimeout(() => {
                const openModalEl = document.querySelector('.modal[style*="flex"] .modal-content');
                if(openModalEl) openModalEl.scrollTop = openModalEl.scrollHeight;
            }, 200);
        }

        function deleteItem(type, idx) {
            const key = `${currentYear}_${months[currentMonthIdx]}`;
            if (userData[key][type][idx].recurring) removeFromFuture(type, userData[key][type][idx].category);
            userData[key][type].splice(idx, 1);
            save();
        }

        function changeMonth(dir) {
            currentMonthIdx += dir;
            if (currentMonthIdx < 0) { currentMonthIdx = 11; currentYear--; }
            else if (currentMonthIdx > 11) { currentMonthIdx = 0; currentYear++; }
            initMonthData(currentYear, currentMonthIdx);
            render();
        }

        async function save() { 
            render(); 
            if (currentUser) {
                await db.collection("users").doc(currentUser.uid).set(userData); 
            }
        }
    </script>
</body>
</html>
